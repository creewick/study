[study](../) > [inet](../) > [email](../) > smtp

# SMTP

[TOC]

## Формат письма

- **Заголовок SMTP**
  - Имя отправляющего узла (EHLO, IP)
  - MAIL FROM
  - RCPT TO
- **Письмо**
  - Заголовки письма (DATE, FROM, TO, MESSAGE-ID, SUBJECT)
  - *Пустая строка*
  - Тело письма

## Заголовки письма

- **Date -** Дата и время создания сообщения, когда сообщение готово и может быть отослано.
- **From -** Разделенные запятой почтовые адреса авторов сообщения. В случае, если адресов несколько, должно быть поле **Sender**.
- **Sender** - Почтовый адрес отправителя. Если поле **From** содержит один адрес, то поле **Sender** может отсутствовать. Если значения полей **Sender** и **From** совпадают, то поле **Sender** должно отсутствовать.
- **Reply-to** - Почтовый адрес, на который автор сообщения желал бы получить ответ.
- **To** - Почтовые адреса основных адресатов. Если адресов несколько - они разделяются запятыми.
- **Cc** - Копии. Почтовые адреса других адресатов. Если адресов несколько - они разделяются запятыми.
- **Bcc** - Слепые копии. Почтовые адреса адресатов, которые будут не видны другими адресатами, получающим это сообщение. Если адресов несколько - они разделяются запятыми.
- **Message-id** - Поле предоставляет уникальный идентификатор сообщения. Идентификатор уникален для всего мира.
- **In-Reply-To** - Содержит идентификатор оригинального сообщения, на которое делается ответ.
- **References** - Содержит идентификатор оригинального сообщения, на которое делается ответ.
- **Subject** - Тема сообщения.
- **Comments** - Содержит дополнительные комментарии к сообщению.
- **Keywords** - Ключевые слова и важные слова, которые могут быть полезны адресату.
- **Resent-Date**, **Resent-From**, **Resent-Sender**, **Resent-To**, **Resent-Cc**, **Resent-Bcc**, **Resent-Message-Id** - Используются при пересылке сообщения. Эти поля содержат информацию, измененную тем, кто производил пересылку.
- **Return-Path** - Почтовый адрес, проставляемый SMTP-сервером на стадии финальной отсылки. Чаще всего используется для доставки отчета с описанием возникшей ошибки.
- **Received** - Используется для идентификации SMTP-серверов, которые принимали участие в отправке сообщения от отправителя к получателю. Каждый SMTP-сервер добавляет свое поле.
- **Encrypted** - Указывает на то, что сообщение было подвергнуто шифрованию.
- **MIME-Version** - Содержит версию MIME. Дополнительную информацию можно получить из документов [RFC 2045](http://tools.ietf.org/html/rfc2045), [RFC 2046](http://tools.ietf.org/html/rfc2046), [RFC 2047](http://tools.ietf.org/html/rfc2047), [RFC 2048](http://tools.ietf.org/html/rfc2048), [RFC 2049](http://tools.ietf.org/html/rfc2049).
- **Content-Type** - Значением этого поля является наиболее полная информация о содержимом сообщения, которая позволяет почтовому клиенту выбрать соответствующий механизм обработки.
- **Content-Transfer-Encoding** - Указывается способ помещения двоичных данных в тело сообщения.
- **Поля начинающиеся с X-** - Дополнительное незарегистрированное поле. Разные почтовые клиенты могут использовать разные незарегистрированные поля для собственных нужд.

## Команды

CRLF == /r/n

| HELLO (HELO)         | HELO <SP> <domain> <CRLF>            | Эта команда используется что бы идентифицировать SMTP-отправителя на принимающем сервере.В случае успешного выполнения этой команды получатель и отправитель готовы к дальнейшей работе. |
| -------------------- | ------------------------------------ | ------------------------------------------------------------ |
| MAIL (MAIL)          | MAIL <SP> FROM:<reverse-path> <CRLF> | Эта команда используется что бы отправить почту по одному или более адресатам. Параметром команды является ваш e-mail адресс. (exp: MAIL FROM: mypost@mail.net) |
| RECIPIENT (RCPT)     | RCPT <SP> TO:<forward-path> <CRLF>   | Эта команда используется что бы определить одного получателя почты.Множество получателей определяются множеством этих команд.(exp: RCPT TO yourpost@mail.net) |
| DATA (DATA)          | DATA <CRLF>                          | Получатель получает данные о дате отправке почты.            |
| SEND (SEND)          | SEND <SP> FROM:<reverse-path> <CRLF> | Эта команда используется для возможности отправки почтовых данных на один или больше почтовых терминалов.Аргумент команды содержит в себе обратный маршрут.Команда считается успешно выполненной, если сообщение будет успешно доставленно на терминал. |
| SEND OR MAIL (SOML)  | SOML <SP> FROM:<reverse-path> <CRLF> | Эта команда используется что бы произвести отправку почты на один или более терминалов или почтовых ящиков. Для каждого получателя почтовые данные доставляются на терминал (если получатель имеет права снимать почту с терминала) иначе на почтовый ящик. Команда считается успешно выполненной, если почта успешно доставленна на почтовый ящик или терминал. |
| SEND AND MAIL (SAML) | SAML <SP> FROM:<reverse-path> <CRLF> | Эта команда используется что бы произвести отправку почты на один или более терминалов и почтовых ящиков. Для каждого получателя почтовые данные доставляются на терминал (если получатель имеет права снимать почту с терминала) и для всех получателей на их почтовые ящики. Команда считается успешно выполненной если почта была доставленна на почтовые ящики. |
| RESET (RSET)         | RSET <CRLF>                          | Эта команда определяет, что текущая работа с почтой должна быть прервана. Все сохранённые отправители и получатели должны разъединиться и буферы передачи должны быть очищенны. Получатель должен послать ОК в ответ на эту команду. |
| VERIFY (VRFY)        | VRFY <SP> <string> <CRLF>            | Эта команда просит подтвердить получателя, что он идентифицировал пользователя по аргументу. Для этого должны быть возвращены имя (полное имя) пользователя или почтовый адресс. |
| EXPAND (EXPN)        | EXPN <SP> <string> <CRLF>            | Эта команда просит, чтобы получатель подтвердил аргументы идентифиции всех в почтовом списке (mailing list) и если это так, то вернул число корреспондентов в этом списке: полное имя пользователя (если знает) и полное название почтового ящика. |
| HELP (HELP)          | HELP [<SP> <string>] <CRLF>          | Эта команда заставляет получателя высылать отправителю HELP команду. Команда может иметь аргумент (любую другую команду) и возвращать различные описания как ответ. |
| NOOP (NOOP)          | NOOP <CRLF>                          | Эта команда не имеет никаких аргументов и не требует предварительного выполнения других команд. Она просит вынуждает получателя ответить ОК. |
| QUIT (QUIT)          | QUIT <CRLF>                          | Эта команда определяет что получатель должен послать команду ОК и затем закрыть канал передачи. |
| TURN (TURN)          | TURN <CRLF>                          | Эта команда означает, что получатель должен:1.Послать ОК в ответ и затем взять на себя роль SMTP передатчика или2.Отвечает отказом и остаётся в роли SMTP приёмника. |

## Extended SMTP

Механизм расширений протокола SMTP 

> S: 220 smtp.example.com ESMTP Postfix
>
> C: EHLO bob.example.org
>
> S: 250 smtp.example.com Hello bob.example.org [192.0.2.201]
>
> S: 250 8BITMIME
>
> S: 250 SIZE 14680064
>
> S: 250 AUTH LOGIN PLAIN CRAM-MD5 DIGEST-MD5
>
> S: 250 STARTTLS
>
> S: 250 PIPELINING S: 250 HELP
>
> S: 250 ETRN
>
> S: 250 CHECKPOINT

 ## AUTH – аутентификация и шифрование 

> S: 220 smtp.server.com Simple Mail Transfer Service Ready
>
> C: EHLO client.example.com
>
> S: 250-smtp.server.com Hello client.example.com
>
> S: 250 AUTH LOGIN PLAIN CRAM-MD5
>
> C: AUTH LOGIN
>
> S: 334 VXNlcm5hbWU6 Base64(Username:)
>
> C: dm92YQ== Base64(vova)
>
> S: 334 UGFzc3dvcmQ6 Base64(Password:)
>
> C: c2VjcmV0X3Bzd2Q= Base64(secret_pswd)
>
> S: 235 2.7.0 Authentication successful

## STARTTLS (Start Transport Layer Security) 

> C: EHLO client.example.com 
>
> S: 250-smtp.server.com Hello client.example.com 
>
> S: 250-AUTH LOGIN PLAIN CRAM-MD5 
>
> S: 250-STARTTLS 
>
> C: STARTTLS 
> 
> S: 220 TLS go ahead 
>
> C: <starts TLS negotiation>
>
> C:  C & S: <negotiate a TLS session and check result of negotiation>
>
> C: EHLO client.example.com *
>
> S: 250-smtp.server.com Hello client.example.com
>
> S: 250-AUTH LOGIN PLAIN CRAM-MD5
>
> C: AUTH LOGIN S: 334 VXNlcm5hbWU6
>
> C: dm92YQ== S: 334 UGFzc3dvcmQ6
>
> C: c2VjcmV0X3Bzd2Q=
>
> S: 235 2.7.0 Authentication successful 

## Multipurpose Internet Mail Extension(MIME) 

__MIME__ – стандарт, описывающий передачу различных типов данных по электронной почте. 

Спецификация для кодирования информации и форматирования сообщений для передачи разного рода информации внутри текстовых данных. 

Определяет набор e-mail-заголовков для определения дополнительных атрибутов сообщения. 

Определяет множество кодировок, которые могут быть использованы для представления 8-битных бинарных данных с помощью символов из 7-битного ASCII.

### Примеры заголовков

> __Mime-Version – версия MIME.__
>
> ​	Mime-Version: 1.0
>
> ​	MIME-Version: 1.0 (Generated by GBD 3.7)
>
> __Content-Type – тип сообщения.__
>
> ​	Content-Type: text/plain; charset=KOI-8
>
> ​	application: octet-stream
>
> __Content-Transfer-Encoding – тип транспортного кодирования__
>
> ​	Content-Transfer-Encoding: base64 

## Заголовок multipart 

Содержимое письма состоит из некоторого множества частей, содержащих данные различных взаимонезависимых типов.

__mixed __ основной подтип;

__alternative__ представление одних и тех же данных в разных форматах;

__parallel__ одновременный просмотр разных частей документа; 

__digest__ объединение в одном письме частей, каждая из которых имеет тип message. 

### Пример multipart/alternative

Content-Type: multipart/alternative; boundary=boundary42

--boundary42 

Content-Type: text/plain; charset=us-ascii



... Здесь содержится версия простым текстом ....

--boundary42

Content-Type: text/richtext



.... Здесь содержится версия с разметкой RFC 1341...

--boundary42

Content-Type: text/x-whatever



.... Здесь содержится версия в гипотетическом формате..

 --boundary42-- 



## BASE64

Схема преобразования произвольной последовательности байт в последовательность печатных ASCII символов.

символы (A—Z, a—z),

цифры (0—9), символы «+» и «/»,

символ «=» в качестве специального кода суффикса.

> Hello, World -> SGVsbG8sIFdvcmxk 

## Настройка зоны DNS: PTR запись 

![1529606596216](img\Настройка зоны DNS - PTR запись.png)

> 44.33.22.11.in-addr.arpa. IN PTR mail.example.com. 

В случае Mail сервера для двух доменов PTR-запись должна указывать на имя почтового хоста (которое он передает в рамках SMTP-сессии), даже если он расположен в другом домене.

## Настройка зоны DNS: SPF



![1529606695111](img\Настройка зоны DNS - SPF.png)

![1529606720959](img\Настройка зоны DNS - SPF - 2.png)

## DomainKeys Identified Mail

DKIM-Signature: __v__=1; __a__=rsa-sha256; __d__=example.net;

__s__=brisbane; __c__=relaxed/simple; __q__=dns/txt; __l__=1234; 

__t__=1117574938; __x__=1118006938;

__h__=from:to:subject:date:keywords:keywords; __bh__=MTIzNDU2Nzg5MDEyMzQ1Njc4OTAxMjM0NTY3ODkwMTI=; __b__=dzdVyOfAKCdLXdJOc9G2q8LoXSlEniSbav+yuU4zGeeruD00lszZVoG4 ZHRNiYzR 

![1529606759348](img\DomainKeys Identified Mail.png)

