<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\(','\)']]}});</script><script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

[home](../../../) > [inet](../../) > [routing](../) > ospf

[study](./../../) > [inet](./../) > [routing](./) > ospf

# OSPF

Open Shortest Path First - протокол динамической маршрутизации, основанный на технологии отслеживании состояния канала.

Протокол внутридоменной маршрутизации.

Используется метрика стоимости, вычисляемая на основе полосы пропускания каналов. 

- Неограниченное число переходов
- Многоадресные анонсы
- Интеллектуальное использование VLSM и CIDR
- Поддержка областей и суммирование маршрутов
- Аутентификация маршрутизации
- Передача и маркировка внешних маршрутов

[TOC]

## Терминология

**Автономная система** - это система IP-сетей и маршрутизаторов, управляемых одним или несколькими операторами, имеющими единую политику маршрутизации с Интернетом

**Канал** - интерфейс на маршрутизаторе

**Соcтояние канала** - описание интерфейса и его отношений с соседними маршрутизаторами

- IP адрес
- Маска сети
- Тип сети
- Маршрутизаторы, подключенные к этой сети

**База данных состояний каналов** - коллекция состояний всех каналов

## Алгоритм при изменении состояния канала

1. Инициализация или изменение маршрутных данных
2. Маршрутизатор генерирует Link State Advertisement (LSA)
3. Маршрутизаторы обмениваются LSA
4. Заполнение базы данных каждого маршрутизатора
5. Маршрутизатор использует алгоритм Дейкстры для вычисления дерева кратчайших путей

## Схема работы OSPF

1. Маршрутизаторы обмениваются hello-пакетами через все интерфейсы, на которых работает OSPF
2. Маршрутизатор переходит в состояние смежности с соседними маршрутизаторами
3. Маршрутизатор посылает объявление о состоянии канала соседям
4. Маршрутизатор, получивший объявление от соседа:
   - Записывает информацию о нем в базу данных
   - Рассылает копию этого объявления всем другим соседям
5. Рассылая объявления через зону, все маршрутизаторы строят идентичную базу данных
6. Когда база данных построена, каждый маршрутизатор использует алгоритм Shortest Path First (SPF) для вычисления графа без петель, который будет описывать кратчайший путь к каждому известному пункту назначения с собой в качестве корня
7. Каждый маршрутизатор строит таблицу маршрутизации, основываясь на своем дереве кратчайшего пути

## Зоны OSPF

Зона (Area) - совокупность сетей и маршрутизаторов, имеющих один и тот же идентификатор зоны.

Разделение на зоны позволяет:

- Снизить нагрузку на ЦПУ маршрутизаторов за счет уменьшения количества перерасчетов про алгоритму SPF
- Уменьшить размер таблиц маршрутизации
- Уменьшить количество пакетов обновлений состояния канала

### Виды зон

- **Backbone** (магистральная, нулевая)

  Формирует ядро сети OSPF. Все остальные зоны соединены с ней, и межзональная маршрутизация происходит через неё.

  Ответственна за распространение маршрутизирующей информации между зонами.

- **Normal** (стандартная)

  Создаётся по умолчанию. Принимает обновления каналов, суммарные и внешние маршруты.

- **Stab** (тупиковая)

  Не принимает внешние маршруты. Не может иметь ASBR.

- **Totally stubby area** 

  Не принимает суммарные и внешние маршруты. 

- **Not-so-stubby area** (NSSA)

  Не принимает внешние маршруты. Может пробрасывать свои внешние. Допускает ASBR.

- **Totally NSSA**

  Не принимает суммарные и внешние маршруты. Может пробрасывать свои внешние. Допускает ASBR.

## Типы маршрутизаторов

- **Внутренний маршрутизатор (internal router)** — маршрутизатор, все интерфейсы которого принадлежат одной зоне. У таких маршрутизаторов только одна база данных состояния каналов.
- **Пограничный маршрутизатор (area border router, ABR)** — соединяет одну или больше зон с магистральной зоной и выполняет функции шлюза для межзонального трафика. У пограничного маршрутизатора всегда хотя бы один интерфейс принадлежит магистральной зоне. Для каждой присоединенной зоны маршрутизатор поддерживает отдельную базу данных состояния каналов.
- **Магистральный маршрутизатор (backbone router)** — маршрутизатор, у которого всегда хотя бы один интерфейс принадлежит магистральной зоне. Определение похоже на пограничный маршрутизатор, однако магистральный маршрутизатор не всегда является пограничным. Внутренний маршрутизатор интерфейсы которого принадлежат нулевой зоне, также является магистральным.
- **Пограничный маршрутизатор автономной системы (AS boundary router, ASBR)** — обменивается информацией с маршрутизаторами, принадлежащими другим автономным системам или не-OSPF маршрутизаторами. Пограничный маршрутизатор автономной системы может находиться в любом месте автономной системы и быть внутренним, пограничным или магистральным маршрутизатором.

## Объявления о состоянии канала (LSA)

LSA - единица данных, которая описывает локальное состояние маршрутизатора или сети.

Множество всех LSA, описывающих маршрутизаторы и сети, образуют базу данных состояния каналов.

### Типы объявлений

- **Type 1 LSA - Router LSA** - объявление о состоянии каналов маршрутизатора
  - Распространяются всеми маршрутизаторами
  - Распространяются только в пределах одной зоны
  - Содержит:
    - Описание всех каналов маршрутизатора
    - Стоимость каждого канала
    - Список соседей на каждой интерфейсе 
- **Type 2 LSA - Network LSA** - объявление о состоянии каналов сети
  - Распространяется *Выделенным Маршрутизатором* (DR) в сетях со множественным доступом
  - Распространяется только в пределах одной зоны
  - Содержит описание всех маршрутизаторов, присоединенных к сети, включая *Выделенный* (DR)
- **Type 3 LSA - Network Summary LSA** - суммарное объявление о состоянии каналов сети
  - Распространяется *Пограничными Маршрутизаторами* (ABR)
  - Распространяется в соседние зоны
  - Конвертирует Type 1 и Type 2 в Network Summary LSA
- **Type 4 LSA - ASBR Summary LSA** - суммарное объявление о состоянии каналов пограничного маршрутизатора.
  - Распространяется *Пограничными Маршрутизаторами Автономной Системы*  (ASBR)
  - Содержит информацию **не о сети**, а о маршрутизаторе (ASBR)
- **Type 5 LSA - AS External LSA** - объявление о состоянии внешних каналов автономной системы
  - Распространяется *Пограничными Маршрутизаторами Автономной Системы* (ASBR)
  - Распространяется в пределах всей автономной системы
  - Содержит описание маршрутов, внешних для автономной системы OSPF, или маршруты по умолчанию
- **Type 6 LSA - Multicast OSPF LSA** - специализированное объявление, которое использует мультикаст OSPF приложения
- **Type 7 LSA - AS External LSA for NSSA** - обявления о состоянии внешних каналов автономной системы в NSSA зоне.
  - Может передаваться только в NSSA зоне
  - На границе зоны пограничный маршрутизатор преобразует в Type 5 - AS External LSA
- **Type 8 LSA - Link LSA** - анонсирует link-local адрес и префикс(ы) маршрутизатора всем маршрутизаторам, разделяющим канал (link).
  - Отправляется только если на канале присутствует более одного маршрутизатора
  - Распространяется в пределах канала (link)
- **Type 9 LSA - Intra-Area-Prefix LSA** - ставит в соответствие: список префиксов IPv6 и маршрутизатор, указывая на Router LSA, список префиксов IPv6 и транзитную сеть, указывая на Network LSA.
  - Распространяются только в пределах одной зоны

### Типы объявлений (коротко)

| Тип LSA               | Кто создаёт? | Границы флуда                |
| --------------------- | ------------ | ---------------------------- |
| (1) Router            | Все          | Зона                         |
| (2) Network           | DR           | Зона                         |
| (3) Summary           | ABR          | Соседние зоны                |
| (4) ASBR Summary      | ASBR         | Соседние зоны                |
| (5) External          | ASBR         | Все зоны                     |
| (6) Multicast OSPF    | -            | -                            |
| (7) NSSA External     | ASBR         | Только NSSA зона (+соседние) |
| (8) Link              | ?            | Канал                        |
| (9) Intra-Area-Prefix | ?            | Зона                         |

