[ study](./../../) > [inet](./../) > [routing](./) > as

# Автономные системы

[TOC]

Интернет состоит из автономных систем.

Протокол BGP выполняет междоменную маршрутизацию.

Можно передавать информацию, полученную с помощью RIP, процессу OSPF (предусмотренно в ПО маршрутизаторов).

![123](.\..\images\Автономные системы\Пример RIP-OSPF.png)

![2](.\..\images\Автономные системы\Автономная система.png)

__Автономная система__: группа из одного или нескольких префиксов IP, работающих у одного или нескольких сетевых операторов, которые имеют __единую__ и __четко определенную__ политику маршрутизации.



## Классификация AS согласно RFC 1772

__Тупиковая (stub)__ - AS, имеющая соединение только с одной AS.

__Многодомная (multihomed)__ - AS, соединенная с несколькими ASЮ но не принимающая транзитный трафик.

__Транзитная__ - AS, соединенная с множеством других AS и предназначенная (с некоторыми ограничениями) для поддержки локального и транзитного трафиков.



## Общие зарактеристики BGP4 по RFC 4271

​	Основной функцией, поддерживающей протокол BGP системы является обмени информацией о доступности сетей с другими системами BGP.

* Поддержка бесклассовой междоменной маршрутизации.

* Поддержка объединения маршрутов.

__!__ BGP поддерживает только парадигму пересылки на основе адреса получателя.

​	BGP использует протокол TCP/179.

## База маршрутной информации BGP4

(Routing Information Base)

__Adj-RIBs-In__ - Маршрутные данные, полученные из входящих сообщений UPDATE, которые были приняты от других узлов BGP.

__Loc-RIB__ - Локальная маршрутная информация узла BGP, выбранная путем применения локальной политики к маршрутам, содержащимся в Adj-RIBs-In.

__Adj-RIBs-OUT__ - информация локального узла BGP, выбранная им для анонсирования своим партнерам.

![3](.\..\images\Автономные системы\База маршрутной информации.png)

## Заголовок BGP

![1528979288221](.\..\images\Автономные системы\Заголовок BGP.png)

__Marker__ - содержит 1 в каждом бите; включено для совместимости с предыдущими версиями BGP.

__Length__ - целое число без знака, показывает размер сообщения (включая заголовок) в октетах(байтах). 19 <= Length <= 4096.

__Type__ - содержит код типа сообщения:

1. __OPEN__
2. __UPDATE__
3. __NOTIFICATION__
4. __KEEPALIVE__

## Сообщение OPEN

![1528979604125](.\..\images\Автономные системы\Сообщение OPEN.png)

__Version__ - номер версии протокола.

__My AS__ - номер AS отправителя сообщения.

__Hold Time__ - число секунд, которое отправитель предлагает установить для таймера удержания.

__BGP Identifier__ - идентификатор узла BGP (IP адрес, присвоенный этому узлу BGP).

__Opt Par Len__ - общий размер поля Optional Parameters в октетах.

__Optional Parameters__ - список дополнительных параметров, представленных в формате __<Param Type, Param Length, Param Value, Capabilities(в RFC3392)>__.

## Сообщение UPDATE

| Withdrawn Routes Length, 2 байта                             |
| ------------------------------------------------------------ |
| __Withdraw Routes__ (переменный размер)                      |
| __Total Path Attribute Length__, 2 байта                     |
| __Path Attributes__ (переменный размер)                      |
| __Network Layer Reachability Information__ (переменный размер) |



__Withdrawn Routes__ - список префиксов IP-адресов для отзываемых маршрутов.

Префикс = <length, prefix>

| 22       | 202.100.44                     |
| -------- | ------------------------------ |
| 00010110 | 11001010.01100100.001011__00__ |

__Path Attributes__ - последовательность переменной длины с атрибутами пути.

![Атрибут пути](C:\Users\Zero.net\Desktop\Studying\Typora\inet\routing\images\8.png)

__Network Layer Reachability Information__ - последовательность переменной длины с адресными префиксами IP.

Префикс = <Length, prefix>

__!__ Сообщение  UPDATE может анонсировать не более одного набора атрибутов пути, но этому пути может соответствовать множество адресатов, путь к которым описывается общим набором атрибутов.

## Сообщение KEEPALIVE и NOTIFICATION

​	BGP не использует на уровне TCP каких-либо механизмов для проверки доступности других узлов. Вместо этого используется сообщение KEEPALIVE.

​	Сообщение NOTIFICATION передаются в случаях обнаружения ошибок. Соединение BGP незамедлительно закрывается после передачи такого сообщения.

## Выбор маршрута

* Максимальное значение Weight
* Максимальное значение Local Preference
* Предпочесть локальный маршрут маршрутизатора (next hop = 0.0.0.0)
* Кратчайший путь через автономные системы (короткий AS_PATH)
* Минимальное значение Origin Code
* Минимальное значение MED
* Путь eBGP лучше чем путь iBGP
* и т.д.

## Инструменты управления трафиком

* AS-Path ACL
* Prefix-list

| Входящий                                | Исходящий        |
| --------------------------------------- | ---------------- |
| AS_Path prepend                         | Weight           |
| MED                                     | Local Preference |
| Community                               | BGP multipath    |
| Анонс разных префиксов через разных ISP |                  |

## Пример построения соединения

![1528985418900](.\..\images\Автономные системы\Исходящий трафик.png)

![1528985598327](.\..\images\Автономные системы\Анонсирование сети.png)

![1528985620752](.\..\images\Автономные системы\Влияние порядка установки сеанса.png)

![1528985630806](.\..\images\Автономные системы\Установили связь с партнером.png)

![1528985642333](.\..\images\Автономные системы\Обрыв канала с основным провайдером.png)

![1528985651107](.\..\images\Автономные системы\Восстановился канал до AS-B.png)

![1528985663494](.\..\images\Автономные системы\Анонс распостранился до AS-C.png)

![1528985672006](.\..\images\Автономные системы\AS-D продолжает отправлять через AS-E.png)

## Route Reflector

![1528986867981](.\..\images\Автономные системы\Route Reflector.png)

## Конфедерации

​	Когда маршруты передаются внутри AS между конфедерациями в их AS-path добавляется номер конфедерации (сегменты AS_CONFED_SEQ и AS_CONFED_SET) для избежания петель.

![1528986982507](.\..\images\Автономные системы\Конфедерации.png)