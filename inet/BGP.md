[study](../) > [inet](./) > bgp

# Протокол BGP

Border Gateway Protocol -основной протокол динамической маршрутизации маршрутизации в Интернете.

Предназначен для обмена информацией о доступностей подсетей между AS.

- Поддержка бесклассовой междоменной маршрутизации.
- Использует суммирование маршрутов для уменьшения таблиц маршрутизации.

Также передаются различные атрибуты этих сетей, с помощью которых BGP выбирает лучший маршрут и настраиваются политики маршрутизации.

Один из основных атрибутов — это список AS, через которые прошла эта информация. Эта информация позволяет BGP определять где находится сеть относительно AS, исключать петли маршрутизации, а также может быть использована при настройке политик. 

* Поддерживает только парадигму пересылки на основе адреса получателя.
* Использует протокол TCP/179.
* Отправляет обновления только после изменения в сети
* Периодически отправляет KEEPALIVE-сообщения для проверки TCP-соединения

[TOC]

## Принцип работы

### Таблицы маршрутизации

* **Таблица соседей** *(Adj-RIBs-In ?)* - список соседних маршрутизаторов
* **Таблица BGP** *(Loc-RIB ?)*:
  * Список сетей, полученных от каждого соседа
  * Может содержать несколько путей к destination сетям
  * Атрибуты BGP для каждого пути
* **Таблица маршрутизации **_(Adj-RIBs-OUT ?)_ - список лучших путей к сетям

![Принцип работы](images\BGP\1.png)

BGP делится на:

- **iBGP** - передача информации внутри АS
- **eBGP** - между AS

Если iBGP-маршрутизаторы работают в нетранзитной AS, то соединение между ними должно быть **full mesh** (каждый-с-каждым). Это следствие принципов работы протокола — если маршрутизатор, находящийся на границе AS, получил обновление, то он передает его всем соседям; соседи, которые находятся внутри автономной системы, больше это обновление не распространяют, так как считают, что все соседи внутри AS уже его получили. 

### Таймеры протокола

**Keepalive Interval** - интервал между отправкой **KEEPALIVE** (60 секунд)

**Hold Time** - таймер, по истечению которого сосед будет считаться недоступным (180 секунд)

## Типы сообщений

### Заголовок BGP

`------Marker-(16-байт)------` `Length(2байт)` `Type(1)`

__Marker__ - содержит 1 в каждом бите, для совместимости с предыдущими версиями BGP.

__Length__ - размер сообщения (включая заголовок) в байтах. 19 ≤ Length ≤ 4096.

__Type__ - содержит код типа сообщения:

1. __OPEN__
2. __UPDATE__
3. __NOTIFICATION__
4. __KEEPALIVE__

### Сообщение OPEN

Используется для установки отношений соседства и обмена базовыми параметрами. Отправляется сразу после установки TCP-соединения.

`Version(1)` `MyAutonomousSystem(2)` `---Hold-Time-(2)---` `---------BGP-Identifier-(4-байт)--------- ` `OptParLen(1)` `Optional-Parameters-(?)`

**Version** - номер версии протокла

**My Autonomous System** - номер AS отправителя

**Hold Time** - макс. время в секундах, которое может пройти между получением **KEEPALIVE** и **UPDATE**

**Optional Parameters Length** - длина дополнительных параметров в байтах. 

* Если 0, то в **Marker** записываются единицы
* Если не 0, то в **Optional Parameters** записываются данные для определения кода в **Marker**

### Сообщение UPDATE

Используется для обмена информацией маршрутизации

`-----Withdrawn-Routes-Length-(2-байта)----`

`-----------Withdrawn-Routes-(?)-----------`

`---Total-Path-Attribute-Length-(2-байта)--`

`------------Path-Attributes-(?)-----------`

`Network-Layer-Reachability-Information-(?)`

__Withdrawn Routes__ - список префиксов IP-адресов для отзываемых маршрутов.

Префикс = Длина, Префикс

| 22       | 202.100.44                     |
| -------- | ------------------------------ |
| 00010110 | 11001010.01100100.001011__00__ |

__Path Attributes__ - последовательность переменной длины с атрибутами пути.

__Network Layer Reachability Information__ - последовательность переменной длины с адресными префиксами IP.

Префикс = Длина, Префикс

__!__ Сообщение  UPDATE может анонсировать не более одного набора атрибутов пути, но этому пути может соответствовать множество адресатов, путь к которым описывается общим набором атрибутов.

### Сообщение NOTIFICATION

Используется, когда возникают ошибки BGP. После отправки сообщения, сессия с соседом разрывается.

`Error-Code-(1)` `ErrorSubcode(1)` `----Data-(6-байт)----`

**Error Code** - тип оповещения:

1. Message Header Error
2. OPEN Message Error
3. UPDATE Message Error
4. Hold Timer Expired
5. Finite State Machine Error
6. Cease

### Сообщение KEEPALIVE

Используется для поддерживания отношений соседства, для обнаружения неактивных соседей.

Сообщения Keepalive состоят только из заголовка пакета (длина 19 байт).

Если периодичность отправки keepalive-сообщений выставлена в 0, то сообщения не отправляются.

## Отношение соседства

Для того чтобы установить отношения соседства, в BGP надо настроить вручную каждого соседа.

Когда указывается сосед локального маршрутизатора, обязательно указывается автономная система соседа. По этой информации BGP определяет тип соседа:

- **Внутренний BGP сосед (iBGP-сосед)** — сосед, который находится в той же автономной системе, что и локальный маршрутизатор. iBGP-соседи не обязательно должны быть непосредственно соединены.
- **Внешний BGP сосед (eBGP-сосед)** — сосед, который находится в автономной системе отличной от локального маршрутизатора. По умолчанию, eBGP-соседи должны быть непосредственно соединены.

Тип соседа мало влияет на установку отношений соседства. Более существенные отличия между различными типами соседей проявляются в процессе отправки обновлений BGP и добавлении маршрутов в таблицу маршрутизации.

BGP выполняет такие проверки, когда формирует отношения соседства:

1. Маршрутизатор должен получить запрос на TCP-соединение с адресом отправителя, который маршрутизатор найдет указанным в списке соседей (команда **neighbor**).
2. Номер автономной системы локального маршрутизатора должен совпадать с номером автономной системы, который указан на соседнем маршрутизаторе командой **neighbor remote-as** (это требование не соблюдается при настройках конфедераций).
3. Идентификаторы маршрутизаторов (Router ID) не должны совпадать.
4. Если настроена аутентификация, то соседи должны пройти её.

У первого пункта проверки есть некоторая особенность: только у одного из двух маршрутизаторов IP-адрес, указанный как адрес отправки обновлений, должен быть указан в команде **neighbor** другого маршрутизатора.

### Состояния связи с соседями

* **IDLE** - ничего не происходит
* **CONNECT** - слушает и посылает пакеты TCP
* **ACTIVE** - ждет ответа
* **OPEN SENT** - сообщение OPEN отправлено
* **OPEN CONFIRM** - сообщение OPEN получено
* **ESTABLISHED** - стабильное состояние соседства

# Не проверено

## Выбор маршрута

- Максимальное значение Weight
- Максимальное значение Local Preference
- Предпочесть локальный маршрут маршрутизатора (next hop = 0.0.0.0)
- Кратчайший путь через автономные системы (короткий AS_PATH)
- Минимальное значение Origin Code
- Минимальное значение MED
- Путь eBGP лучше чем путь iBGP
- и т.д.

## Инструменты управления трафиком

- AS-Path ACL
- Prefix-list

| Входящий                                | Исходящий        |
| --------------------------------------- | ---------------- |
| AS_Path prepend                         | Weight           |
| MED                                     | Local Preference |
| Community                               | BGP multipath    |
| Анонс разных префиксов через разных ISP |                  |

## Пример построения соединения

![1528985418900](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D1%8F%D1%89%D0%B8%D0%B9%20%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA.png)

![1528985598327](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/%D0%90%D0%BD%D0%BE%D0%BD%D1%81%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D1%81%D0%B5%D1%82%D0%B8.png)

![1528985620752](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/%D0%92%D0%BB%D0%B8%D1%8F%D0%BD%D0%B8%D0%B5%20%D0%BF%D0%BE%D1%80%D1%8F%D0%B4%D0%BA%D0%B0%20%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B8%20%D1%81%D0%B5%D0%B0%D0%BD%D1%81%D0%B0.png)

![1528985630806](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D0%BB%D0%B8%20%D1%81%D0%B2%D1%8F%D0%B7%D1%8C%20%D1%81%20%D0%BF%D0%B0%D1%80%D1%82%D0%BD%D0%B5%D1%80%D0%BE%D0%BC.png)

![1528985642333](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/%D0%9E%D0%B1%D1%80%D1%8B%D0%B2%20%D0%BA%D0%B0%D0%BD%D0%B0%D0%BB%D0%B0%20%D1%81%20%D0%BE%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D1%8B%D0%BC%20%D0%BF%D1%80%D0%BE%D0%B2%D0%B0%D0%B9%D0%B4%D0%B5%D1%80%D0%BE%D0%BC.png)

![1528985651107](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/%D0%92%D0%BE%D1%81%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D0%BB%D1%81%D1%8F%20%D0%BA%D0%B0%D0%BD%D0%B0%D0%BB%20%D0%B4%D0%BE%20AS-B.png)

![1528985663494](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/%D0%90%D0%BD%D0%BE%D0%BD%D1%81%20%D1%80%D0%B0%D1%81%D0%BF%D0%BE%D1%81%D1%82%D1%80%D0%B0%D0%BD%D0%B8%D0%BB%D1%81%D1%8F%20%D0%B4%D0%BE%20AS-C.png)

![1528985672006](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/AS-D%20%D0%BF%D1%80%D0%BE%D0%B4%D0%BE%D0%BB%D0%B6%D0%B0%D0%B5%D1%82%20%D0%BE%D1%82%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D1%8F%D1%82%D1%8C%20%D1%87%D0%B5%D1%80%D0%B5%D0%B7%20AS-E.png)

## Route Reflector

![1528986867981](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/Route%20Reflector.png)

## Конфедерации

​	Когда маршруты передаются внутри AS между конфедерациями в их AS-path добавляется номер конфедерации (сегменты AS_CONFED_SEQ и AS_CONFED_SET) для избежания петель.

![1528986982507](images\Автономные системы\Конфедерации.png)