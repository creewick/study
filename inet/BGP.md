[study](../) > [inet](./) > bgp

# Протокол BGP

Border Gateaway Protocol - динамический протокол внешней маршрутизации.

На текущий момент является основным протоколом динамической маршрутизации в Интернет.

Предназначен для обмена информацией о доступностей подсетей между AS.

- Поддержка бесклассовой междоменной маршрутизации.
- Использует суммирование маршрутов для уменьшения таблиц маршрутизации.

BGP поддерживает только парадигму пересылки на основе адреса получателя.

BGP использует протокол TCP/179.

[TOC]

В простейшей реализации, все маршрутизаторы одной AS, участвующие в BGP, должны быть настроены каждый-с-каждым. 

Это вызывает проблемы масштабирования, т.к. число требуемых соединений растет квадратично с количеством маршрутизаторов.

Чтобы устраинить проблему, BGP реализует два варианта:

* Отражатели маршрутов *(RFC 4456)*
* Конфедерации *(RFC 5065)*

BGP делится на:

* **iBGP** - необходим для передачи BGP-маршрутов внутри одной AS
* **eBGP** - BGP между AS

## Принцип работы

Устройства, между которыми устанавливается BGP-сессия, называются BGP-соседями.

BGP не обнаруживает соседей автоматически - каждый сосед настраивается вручную. Процесс установления соседей происходит следующим образом:

1. Изначальное состояние соседства - **IDLE**. Ничего не происходит

   BGP находится в состоянии **IDLE**, если нет маршрута к соседу.

2. Маршрутизаторы устанавливают TCP-соединение.

   Когда маршрутизатор слушает - состояние **CONNECT**. Когда ожидает ответа - **ACTIVE**.

3. Маршрутизаторы начинают обмен сообщениями **OPEN**.

4. Второй маршрутизатор получает сообщение **OPEN**, отправляет свой **OPEN** и подтверждение получения: **KEEPALIVE**. 

5. Маршрутизаторы переходят в состояние **ESTABLISHED**. Теперь они могут обмениваться маршрутной информацией. Для этого используются сообщения **UPDATE**.

6. Теперь каждый маршрутизатор регулярно будет рассылать сообщения **KEEPALIVE**. Таймаут - 60 секунд.

## Базы маршрутной информации

__Adj-RIBs-In__ - Маршрутные данные, полученные из входящих сообщений UPDATE, которые были приняты от других узлов BGP.

__Loc-RIB__ - Локальная маршрутная информация узла BGP, выбранная путем применения локальной политики к маршрутам, содержащимся в **Adj-RIBs-In**.

__Adj-RIBs-OUT__ - информация локального узла BGP, выбранная им для анонсирования своим партнерам.

## Заголовок BGP

`------Маркер-(16-байт)------` `Длина(2-байт)` `Тип(1)`

__Маркер__ - содержит 1 в каждом бите, для совместимости с предыдущими версиями BGP.

__Длина__ - размер сообщения (включая заголовок) в байтах. 19 ≤ Length ≤ 4096.

__Тип__ - содержит код типа сообщения:

1. __OPEN__
2. __UPDATE__
3. __NOTIFICATION__
4. __KEEPALIVE__
5. __ROUTE-REFRESH__

## Сообщение OPEN

`Версия(1)` `АС-Отправителя(2)` `Таймер-удержания(2)` `Идентификатор-узла-BGP-(4-байт) ` `Длина(1)` `Дополнительные-параметры-(?)`

**Версия** - номер версии протокла

Номер **АС отправителя**

**Таймер удержания** в секундах, предалаемый отправителем

**Идентификатор узла BGP** - IP адрес, присвоенный этому узлу

**Длина** дополнительных параметров в байтах

**Дополнительные параметры** в формате: Тип, Длина, Значение

## Сообщение UPDATE

`Withdrawn Routes Length (2 байта)`

`Withdrawn Routes (?)`

`Total Path Attribute Length (2 байта)`

`Path Attributes (?)`

`Network Layer Reachability Information (?)`

__Withdrawn Routes__ - список префиксов IP-адресов для отзываемых маршрутов.

Префикс = Длина, Префикс

| 22       | 202.100.44                     |
| -------- | ------------------------------ |
| 00010110 | 11001010.01100100.001011__00__ |

__Path Attributes__ - последовательность переменной длины с атрибутами пути.

__Network Layer Reachability Information__ - последовательность переменной длины с адресными префиксами IP.

Префикс = <Length, prefix>

__!__ Сообщение  UPDATE может анонсировать не более одного набора атрибутов пути, но этому пути может соответствовать множество адресатов, путь к которым описывается общим набором атрибутов.

## Сообщение KEEPALIVE и NOTIFICATION

​	BGP не использует на уровне TCP каких-либо механизмов для проверки доступности других узлов. Вместо этого используется сообщение KEEPALIVE.

​	Сообщение NOTIFICATION передаются в случаях обнаружения ошибок. Соединение BGP незамедлительно закрывается после передачи такого сообщения.

## Выбор маршрута

- Максимальное значение Weight
- Максимальное значение Local Preference
- Предпочесть локальный маршрут маршрутизатора (next hop = 0.0.0.0)
- Кратчайший путь через автономные системы (короткий AS_PATH)
- Минимальное значение Origin Code
- Минимальное значение MED
- Путь eBGP лучше чем путь iBGP
- и т.д.

## Инструменты управления трафиком

- AS-Path ACL
- Prefix-list

| Входящий                                | Исходящий        |
| --------------------------------------- | ---------------- |
| AS_Path prepend                         | Weight           |
| MED                                     | Local Preference |
| Community                               | BGP multipath    |
| Анонс разных префиксов через разных ISP |                  |

## Пример построения соединения

![1528985418900](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D1%8F%D1%89%D0%B8%D0%B9%20%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA.png)

![1528985598327](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/%D0%90%D0%BD%D0%BE%D0%BD%D1%81%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D1%81%D0%B5%D1%82%D0%B8.png)

![1528985620752](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/%D0%92%D0%BB%D0%B8%D1%8F%D0%BD%D0%B8%D0%B5%20%D0%BF%D0%BE%D1%80%D1%8F%D0%B4%D0%BA%D0%B0%20%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B8%20%D1%81%D0%B5%D0%B0%D0%BD%D1%81%D0%B0.png)

![1528985630806](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D0%BB%D0%B8%20%D1%81%D0%B2%D1%8F%D0%B7%D1%8C%20%D1%81%20%D0%BF%D0%B0%D1%80%D1%82%D0%BD%D0%B5%D1%80%D0%BE%D0%BC.png)

![1528985642333](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/%D0%9E%D0%B1%D1%80%D1%8B%D0%B2%20%D0%BA%D0%B0%D0%BD%D0%B0%D0%BB%D0%B0%20%D1%81%20%D0%BE%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D1%8B%D0%BC%20%D0%BF%D1%80%D0%BE%D0%B2%D0%B0%D0%B9%D0%B4%D0%B5%D1%80%D0%BE%D0%BC.png)

![1528985651107](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/%D0%92%D0%BE%D1%81%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D0%BB%D1%81%D1%8F%20%D0%BA%D0%B0%D0%BD%D0%B0%D0%BB%20%D0%B4%D0%BE%20AS-B.png)

![1528985663494](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/%D0%90%D0%BD%D0%BE%D0%BD%D1%81%20%D1%80%D0%B0%D1%81%D0%BF%D0%BE%D1%81%D1%82%D1%80%D0%B0%D0%BD%D0%B8%D0%BB%D1%81%D1%8F%20%D0%B4%D0%BE%20AS-C.png)

![1528985672006](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/AS-D%20%D0%BF%D1%80%D0%BE%D0%B4%D0%BE%D0%BB%D0%B6%D0%B0%D0%B5%D1%82%20%D0%BE%D1%82%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D1%8F%D1%82%D1%8C%20%D1%87%D0%B5%D1%80%D0%B5%D0%B7%20AS-E.png)

## Route Reflector

![1528986867981](D:/Documents/Study/inet/images/%D0%90%D0%B2%D1%82%D0%BE%D0%BD%D0%BE%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B/Route%20Reflector.png)

## Конфедерации

​	Когда маршруты передаются внутри AS между конфедерациями в их AS-path добавляется номер конфедерации (сегменты AS_CONFED_SEQ и AS_CONFED_SET) для избежания петель.

![1528986982507](images\Автономные системы\Конфедерации.png)